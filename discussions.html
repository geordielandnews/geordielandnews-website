<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="google-adsense-account" content="ca-pub-6068321329701529">
  <meta name="viewport" content="width=1200, initial-scale=1.0, user-scalable=yes">
  <title>Geordie Land News - Home</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    /* ------------------------------
       SECTION BARS
    ------------------------------ */
    .section-bar1, .section-bar2, .section-bar3, .section-bar4, .section-bar6, .section-bar7 {
      width: 100%;
      height: 10px;
      background-color: #cccccc;
      margin: 0;
      padding: 0;
    }

    .section-bar2, .section-bar3, .section-bar4, .section-bar6, .section-bar7 { margin-top: 10px; }

    .section-bar5 {
      width: 100%;
      height: 10px;
      background-color: #cccccc;
      margin: 0;
      padding: 0;
      margin-top: 10px;      
      margin-bottom: 0px;
      padding-bottom: 0px;
    }

    /* ------------------------------
       PAGE LAYOUT
    ------------------------------ */


    .page-layout {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 2080px;
      margin: 0 auto;
    }

    .content-center {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin: 10px 10px 0 10px;
    }



.discussion-box { width:100%; width: 1017px; margin-top: 10px; margin-left: 440px; margin:auto; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding-bottom:20px; }
.discussion-header { background:#002147; color:white; font-weight:bold; padding:10px 15px; font-size:14px; display:flex; align-items:center; gap:12px; }
.discussion-header .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }

.btn { padding:6px 10px; border-radius:4px; cursor:pointer; font-size:13px; border:1px solid #002147; background:white; color:#002147; }
.btn.primary { background:#002147; color:white; border:none; }
.btn-small { padding:2px 6px; font-size:11px; border:none; background:#d32f2f; color:white; border-radius:3px; cursor:pointer; margin-left:6px; }
.btn-small:hover { background:#b71c1c; }

.discussion-items { display:flex; flex-direction:column; gap:8px; padding:10px; }
.discussion-item { display:flex; flex-direction:column; gap:6px; border-bottom:1px solid #e0e0e0; padding:10px; }
.discussion-title { font-weight:bold; color:#0070b8; font-size:15px; }
.discussion-content { font-size:13px; color:#444; }
.discussion-meta { font-size:11px; color:#999; display:flex; align-items:center; gap:6px; }
img.post-image { max-width:200px; margin-top:6px; }
.small { font-size:12px; color:#fff; }

.comments-section { margin-top:12px; padding-left:10px; border-left:3px solid #e0e0e0; }
.comment-item { background:#fff; border:1px solid #e0e0e0; padding:10px; border-radius:4px; margin-top:8px; }
.comment-title { font-weight:bold; font-size:14px; color:#0070b8; }
.comment-text { font-size:13px; color:#444; margin-top:4px; }
.comment-meta { font-size:11px; color:#999; display:flex; align-items:center; gap:6px; margin-top:6px; }
.comment-likes-row { display:flex; align-items:center; gap:6px; margin-top:6px; }
.add-comment-box { margin-top:8px; display:flex; gap:6px; }
.add-comment-box input { flex:1; padding:6px; border-radius:4px; border:1px solid #ccc; font-size:13px; }
.add-comment-box button { padding:6px 10px; background:#002147; color:white; border:none; border-radius:4px; cursor:pointer; }

/* Like/Dislike Buttons */
.like-btn-box, .dislike-btn-box, .comment-like-btn-box, .comment-dislike-btn-box {
  display:inline-block; padding:2px 6px; font-size:11px; border-radius:3px; cursor:pointer; user-select:none;
  border:1px solid #0070b8; background:white; color:#0070b8;
}
.like-btn-box:hover, .comment-like-btn-box:hover { background:#0070b8; color:white; }
.dislike-btn-box, .comment-dislike-btn-box { border-color:#d32f2f; color:#d32f2f; }
.dislike-btn-box:hover, .comment-dislike-btn-box:hover { background:#d32f2f; color:white; }

/* Panels */
.panel-backdrop { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background-color: rgba(0,33,71,0.85); justify-content:center; align-items:center; }
.panel { background:#f1f1f1; padding:18px; border-radius:8px; width:95%; max-width:500px; position:relative; }
.close-panel { position:absolute; top:10px; right:15px; font-size:26px; color:#002147; cursor:pointer; }
.panel label { display:block; margin-top:10px; font-size:13px; }
.panel input, .panel textarea { width: calc(100% - 20px); padding:8px; font-size:14px; margin-top:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
.panel textarea { resize: vertical; }
.error { color:red; font-size:12px; margin-top:5px; }

.postImage:disabled { background: #f0f0f0; color: #777; cursor: not-allowed; }
.file-placeholder { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; color: #777; background: #f0f0f0; cursor: not-allowed; box-sizing: border-box; }

</style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <img src="pictures/newcastle-logo.png" alt="Newcastle Logo" class="logo" />
    <h1 class="title">Geordie Land News</h1>
  </header>

  <!-- Navbar -->
  <nav class="navbar">
    <ul>
      <li><a href="home.html">HOME</a></li>
      <li><a href="news.html">NEWS</a></li>
      <li><a href="fixtures.html">FIXTURES</a></li>
      <li><a href="squad.html">SQUAD</a></li>
      <li><a href="transfers.html">TRANSFERS</a></li>
      <li><a href="stats.html">STATS</a></li>
      <li><a href="discussions.html">DISCUSSIONS</a></li>
    </ul>
  </nav>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6068321329701529"
     crossorigin="anonymous"></script>

<!-- Left ad panel -->
<div class="ad-panel-left">

  <div class="ad-slot-1-left">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:250px"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="4894416560"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-2-left">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:250px"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="9069465293"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-3-left">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="5704935359"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-4-left">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="5441211478"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

</div>

<!-- Right ad panel -->
<div class="ad-panel-right">

  <div class="ad-slot-1-right">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="8013186883"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-2-right">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="5026278508"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-3-right">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="4420623902"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="ad-slot-4-right">
    <ins class="adsbygoogle"
         style="display:inline-block;width:430px;height:25%"
         data-ad-client="ca-pub-6068321329701529"
         data-ad-slot="7762202843"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

</div>

<style>
#adblock-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.95);
  display: none; /* hidden by default */
  justify-content: center;
  align-items: center;
  text-align: center;
  z-index: 9999;
  color: #fff;
  overflow: hidden;
}

#adblock-overlay .box {
  background: #222;
  padding: 30px;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
  box-sizing: border-box;
}

#adblock-overlay button {
  margin-top: 15px;
  padding: 12px 24px;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  cursor: pointer;
  background: #f44336;
  color: #fff;
}

/* Hidden bait element to detect ad blockers */
#ad-bait {
  width: 1px;
  height: 1px;
  position: absolute;
  left: -1000px;
  top: -1000px;
}
</style>

<!-- Bait element for ad blocker detection -->
<div id="ad-bait" class="ads adsbygoogle ad-banner ad-container"></div>

<!-- Overlay HTML -->
<div id="adblock-overlay">
  <div class="box">
    <h2>Ad Blocker Detected ðŸš«</h2>
    <p>We rely on advertising to keep this site free.<br>
       Please disable your ad blocker to continue.</p>
    <button id="refresh-btn">Iâ€™ve Disabled Adblock</button>
  </div>
</div>

<script>
window.addEventListener('load', () => {
  function checkAdblock() {
    const bait = document.getElementById('ad-bait');
    if (!bait) return true; // removed by ad blocker
    const style = getComputedStyle(bait);
    // blocked if hidden or removed
    return style.display === 'none' || style.visibility === 'hidden' || bait.offsetParent === null;
  }

  // Force overlay to show if ad blocker detected
  const overlay = document.getElementById('adblock-overlay');
  if (checkAdblock()) {
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // Button reloads the page
  document.getElementById('refresh-btn').addEventListener('click', () => {
    location.reload();
  });
});
</script>  

  <div class="section-bar1"></div>

<style>
  .ad-footer {
    margin-top: 10px;
    margin-bottom: 10px;
    width: 100%;
    height: 150px;
    border: 2px dashed #999;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #666;
    font-size: 18px;
    text-align: center;
    background-color: #fff; 
    cursor: pointer;
    transition: border-color 0.3s;
  }
</style>

<div class="ad-footer">Advertise here! Contact for more info!</div>   

<div class="section-bar2"></div>

  <!-- Content below the section bar -->
  <div class="content-below-bar1">

<div class="content-center">
  <div class="discussion-box">
    <div class="discussion-header">
      Fan Discussions
      <div class="actions">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn primary" id="newPostBtn">New Post</button>
        <div id="userArea"><button class="btn" id="loginOpenBtn">Sign In</button></div>
      </div>
    </div>
    <div class="discussion-items" id="discussionContainer"></div>
  </div>
</div>

<!-- AUTH PANEL -->
<div id="authPanel" class="panel-backdrop">
  <div class="panel">
    <span class="close-panel" id="closeAuthPanel">&times;</span>
    <h2 id="authTitle">Sign In</h2>
    <div id="signinForm">
      <label>Email</label><input type="email" id="signinEmail">
      <label>Password</label><input type="password" id="signinPassword">
      <div style="margin-top:8px;">
        <button class="btn primary" id="signinBtn">Sign In</button>
        <button class="btn" id="showRegisterBtn">Create account</button>
      </div>
      <div id="signinMessage" class="error"></div>
    </div>
    <div id="registerForm" style="display:none;">
      <label>Username</label><input type="text" id="regUsername">
      <label>Email</label><input type="email" id="regEmail">
      <label>Password</label><input type="password" id="regPassword">
      <div style="margin-top:8px;">
        <button class="btn primary" id="registerBtn">Register & Sign In</button>
        <button class="btn" id="showSigninBtn">Back</button>
      </div>
      <div id="registerMessage" class="error"></div>
    </div>
  </div>
</div>

<!-- PROFILE PANEL -->
<div id="profilePanel" class="panel-backdrop">
  <div class="panel">
    <span class="close-panel" id="closeProfilePanel">&times;</span>
    <h2>Profile Settings</h2>
    <label>Display Name</label>
    <input type="text" id="profileDisplayName">
    <button class="btn primary" id="saveProfileBtn" style="margin-top:10px;">Save Changes</button>
    <div id="profileMessage" class="error"></div>
  </div>
</div>

<!-- NEW POST PANEL -->
<div id="newPostPanel" class="panel-backdrop">
  <div class="panel">
    <span class="close-panel" id="closeNewPost">&times;</span>
    <h2>New Post</h2>
    <label>Title</label><input type="text" id="postTitle">
    <label>Content</label><textarea id="postContent" rows="4"></textarea>
    <label>Image (optional)</label><div class="file-placeholder">Temporarily not available</div>
    <button class="btn primary" id="submitPost" style="margin-top:10px;">Submit Post</button>
    <div id="postError" class="error"></div>
  </div>
</div>

<!-- DELETE CONFIRM PANEL -->
<div id="deleteConfirmPanel" class="panel-backdrop">
  <div class="panel">
    <span class="close-panel" id="closeDeletePanel">&times;</span>
    <h2>Confirm Delete</h2>
    <p id="deleteMessage">Are you sure you want to delete this item?</p>
    <div style="margin-top:12px; display:flex; gap:8px;">
      <button class="btn primary" id="confirmDeleteBtn">Yes, Delete</button>
      <button class="btn" id="cancelDeleteBtn">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
/* --- IMPORTS --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

import {
  getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, updateProfile
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

import {
  getFirestore, collection, addDoc, doc, setDoc, deleteDoc,
  query, orderBy, where, getDocs, onSnapshot, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

/* --- FIREBASE CONFIG --- */
const firebaseConfig = {
  apiKey: "AIzaSyBSKmDZW0C_RF_J9BRvc2lUt_gTf2GRp64",
  authDomain: "geordielandnews-37100.firebaseapp.com",
  projectId: "geordielandnews-37100",
  storageBucket: "geordielandnews-37100.appspot.com",
  messagingSenderId: "336635893130",
  appId: "1:336635893130:web:ff71b65b148d7622faa473"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ELEMENTS */
const userArea = document.getElementById("userArea");
const authPanel = document.getElementById("authPanel");
const signinForm = document.getElementById("signinForm");
const registerForm = document.getElementById("registerForm");
const newPostPanel = document.getElementById("newPostPanel");
const discussionContainer = document.getElementById("discussionContainer");
const deleteConfirmPanel = document.getElementById("deleteConfirmPanel");
const deleteMessage = document.getElementById("deleteMessage");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const closeDeletePanel = document.getElementById("closeDeletePanel");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

let deleteTarget = null;

/* ---------------------------
      REFRESH
----------------------------*/
document.getElementById("refreshBtn").onclick = () => {
  window.location.reload();
};

/* ---------------------------
      AUTH LOGIC
----------------------------*/
function showSignInMenu() {
  signinForm.style.display = "block";
  registerForm.style.display = "none";
  authTitle.innerText = "Sign In";
  signinMessage.innerText = "";
  registerMessage.innerText = "";
  authPanel.style.display = "flex";
}

document.getElementById("loginOpenBtn")?.addEventListener("click", showSignInMenu);
document.getElementById("closeAuthPanel")?.addEventListener("click", ()=>authPanel.style.display="none");
document.getElementById("showRegisterBtn")?.addEventListener("click", ()=>{signinForm.style.display="none"; registerForm.style.display="block"; authTitle.innerText="Create Account";});
document.getElementById("showSigninBtn")?.addEventListener("click", showSignInMenu);

document.getElementById("signinBtn")?.addEventListener("click", async () => {
  const email = signinEmail.value.trim();
  const password = signinPassword.value.trim();

  try {
    await signInWithEmailAndPassword(auth, email, password);
    authPanel.style.display = "none";
  } catch(err) {
    signinMessage.innerText = "Incorrect email or password.";
    console.log("Firebase sign-in error code:", err.code);
  }
});

/* ---------------------------
      REGISTER
----------------------------*/
document.getElementById("registerBtn")?.addEventListener("click", async () => {
  const username = regUsername.value.trim();
  const email = regEmail.value.trim();
  const password = regPassword.value.trim();

  registerMessage.innerText = "";

  // USERNAME REQUIRED
  if (!username) {
    registerMessage.innerText = "Please enter a username.";
    return;
  }

  const usernameLower = username.toLowerCase(); // normalize username

  // DEBUG CODE //
  console.log("Checking username:", usernameLower);
  try {
    const usernameRef = doc(db, "users", usernameLower);
    const usernameSnap = await getDoc(usernameRef);
    console.log("getDoc result:", usernameSnap.exists());
  } catch (err) {
    console.error("getDoc failed:", err);
  }

  // CHECK IF USERNAME ALREADY EXISTS
  try {
    const usernameRef = doc(db, "users", usernameLower);
    const usernameSnap = await getDoc(usernameRef);
    if (usernameSnap.exists()) {
      registerMessage.innerText = "Username already taken";
      return;
    }
  } catch (err) {
    console.error("Could not verify username:", err);
    registerMessage.innerText = "Could not verify username.";
    return;
  }

  // EMAIL REQUIRED
  if (!email) {
    registerMessage.innerText = "Please enter an email address.";
    return;
  }

  // PASSWORD RULES
  const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{6,20}$/;
  if (!passwordPattern.test(password)) {
    registerMessage.innerText =
      "Password must contain:\n" +
      "- At least 1 uppercase character\n" +
      "- At least 1 lowercase character\n" +
      "- At least 1 number\n" +
      "- At least 1 special character\n" +
      "- 6â€“20 characters long";
    return;
  }

  // CREATE USER
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    await updateProfile(cred.user, { displayName: username });

    // Save username as document ID (lowercase)
    await setDoc(doc(db, "users", usernameLower), {
      uid: cred.user.uid,
      email,
      username,
      createdAt: serverTimestamp()
    });

    console.log("User registered successfully:", username, email);
    authPanel.style.display = "none";
  } catch (err) {
    console.error("Registration error:", err.code, err.message);
    if (err.code === "auth/email-already-in-use") {
      registerMessage.innerText = "This email is already registered.";
    } else if (err.code === "auth/invalid-email") {
      registerMessage.innerText = "Invalid email address.";
    } else if (err.code === "auth/weak-password") {
      registerMessage.innerText = "Password is too weak.";
    } else {
      registerMessage.innerText = "Registration failed: " + err.message;
    }
  }
});

/* ---------------------------
      AUTH STATE
----------------------------*/
onAuthStateChanged(auth,user=>{
  if(user){
    userArea.innerHTML=`<span class="small">Signed in as <strong>${user.displayName||user.email}</strong></span> <button class="btn" id="logoutBtn">Logout</button> <button class="btn" id="profileBtn">Profile</button>`;
    document.getElementById("logoutBtn").onclick=()=>auth.signOut();
    document.getElementById("profileBtn").onclick=()=>{
      profilePanel.style.display="flex";
      profileDisplayName.value = auth.currentUser.displayName || "";
      profileMessage.innerText = "";
    };
  } else {
    userArea.innerHTML=`<button class="btn" id="loginOpenBtn">Sign In</button>`;
    document.getElementById("loginOpenBtn").onclick=showSignInMenu;
  }
});

/* ---------------------------
      PROFILE PANEL (username doc IDs)
----------------------------*/
const profilePanel = document.getElementById("profilePanel");
const closeProfilePanel = document.getElementById("closeProfilePanel");
const profileDisplayName = document.getElementById("profileDisplayName");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileMessage = document.getElementById("profileMessage");

closeProfilePanel.onclick = () => profilePanel.style.display = "none";

saveProfileBtn.onclick = async () => {
  if (!auth.currentUser) return showSignInMenu();
  const newName = profileDisplayName.value.trim();
  profileMessage.innerText = "";

  if (!newName) {
    profileMessage.innerText = "Display name cannot be empty.";
    return;
  }

  const newNameLower = newName.toLowerCase();

  try {
    const usernameRef = doc(db, "users", newNameLower);
    const usernameSnap = await getDoc(usernameRef);

    // If exists and not current user
    if (usernameSnap.exists() && usernameSnap.data().uid !== auth.currentUser.uid) {
      profileMessage.innerText = "Name already taken";
      return;
    }

    // Delete old username doc if different
    if (auth.currentUser.displayName && auth.currentUser.displayName.toLowerCase() !== newNameLower) {
      await deleteDoc(doc(db, "users", auth.currentUser.displayName.toLowerCase()));
    }

    // Update new display name in Auth
    await updateProfile(auth.currentUser, { displayName: newName });

    // Create or update doc at users/<newNameLower>
    await setDoc(usernameRef, {
      email: auth.currentUser.email,
      uid: auth.currentUser.uid,
      username: newName,
      createdAt: serverTimestamp()
    });

    profilePanel.style.display = "none";
  } catch (err) {
    console.error("Profile update error:", err);
    profileMessage.innerText = "Could not update profile.";
  }
};

/* ---------------------------
      NEW POST
----------------------------*/
const newPostBtn = document.getElementById("newPostBtn");
const closeNewPostBtn = document.getElementById("closeNewPost");

newPostBtn.onclick = () => {
  if (!auth.currentUser) return showSignInMenu();

  // Clear inputs
  postTitle.value = "";
  postContent.value = "";
  postError.innerText = "";

  newPostPanel.style.display = "flex";
};

closeNewPostBtn.onclick = () => newPostPanel.style.display = "none";

document.getElementById("submitPost").onclick = async () => {
  const title = postTitle.value.trim();
  const content = postContent.value.trim();

  if (!title || !content) {
    postError.innerText = "Please fill all fields.";
    return;
  }

  await addDoc(collection(db, "posts"), {
    title,
    content,
    imageUrl: "",
    author: auth.currentUser.displayName || auth.currentUser.email,
    uid: auth.currentUser.uid,
    createdAt: serverTimestamp()
  });

  newPostPanel.style.display = "none";
};

/* ---------------------------
      RENDER POSTS
----------------------------*/
function renderPosts(posts){
  discussionContainer.innerHTML="";
  posts.forEach(p=>{
    const div=document.createElement("div");
    div.className="discussion-item";
    div.innerHTML=`
      <div class="discussion-title">${p.title}</div>
      <div class="discussion-content">${p.content}</div>
      ${p.imageUrl?`<img class="post-image" src="${p.imageUrl}">`:""}
      <div class="discussion-meta">
        By ${p.author} â€” ${p.createdAt?.toDate? p.createdAt.toDate().toLocaleString():""}
        ${auth.currentUser && auth.currentUser.uid===p.uid?`<button class="btn-small delete-post-btn" data-id="${p.id}">Delete</button>`:""}
        | <span class="view-count" data-id="${p.id}">0 views</span>
      </div>

      <div class="likes-row" data-id="${p.id}">
        <span class="like-btn-box">Like <span class="like-count">0</span></span>
        <span class="dislike-btn-box">Dislike <span class="dislike-count">0</span></span>
      </div>

      <div class="comments-section" id="comments-${p.id}">
        <div class="comments-list"></div>
        ${auth.currentUser?
          `<div class="add-comment-box">
             <input id="comment-input-${p.id}" placeholder="Add a comment...">
             <button onclick="submitComment('${p.id}')">Post</button>
           </div>`
        :
          `<div style="font-size:12px;color:#777;margin-top:6px;">Sign in to comment.</div>`}
      </div>
    `;
    discussionContainer.appendChild(div);

    recordView(p.id);
    loadViewCount(p.id);
    loadComments(p.id);
    loadLikeState(p.id);
    loadDislikeState(p.id);
  });
}

/* ---------------------------
      LOAD POSTS
----------------------------*/
const postsRef = collection(db,"posts");
const postsQuery = query(postsRef, orderBy("createdAt","desc"));
onSnapshot(postsQuery,snap=>{
  const arr=[];
  snap.forEach(doc=>arr.push({id:doc.id,...doc.data()}));
  renderPosts(arr);
});

/* ---------------------------
      COMMENTS
----------------------------*/
window.submitComment = async function(postId){
  const input=document.getElementById("comment-input-"+postId);
  const text=input.value.trim();
  if(!text) return;

  await addDoc(collection(db,"posts",postId,"comments"),{
    text,
    author: auth.currentUser.displayName || auth.currentUser.email,
    uid: auth.currentUser.uid,
    createdAt: serverTimestamp()
  });

  input.value="";
};

function loadComments(postId){
  const commentsRef=collection(db,"posts",postId,"comments");
  const q=query(commentsRef,orderBy("createdAt","asc"));
  onSnapshot(q,snap=>{
    const listDiv=document.querySelector(`#comments-${postId} .comments-list`);
    listDiv.innerHTML="";
    snap.forEach(docu=>{
      const c=docu.data();
      const div=document.createElement("div");
      div.className="comment-item";
      div.innerHTML=`
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="comment-title">${c.author}</div>
          ${auth.currentUser && auth.currentUser.uid===c.uid?
             `<button class="btn-small delete-comment-btn" data-postid="${postId}" data-commentid="${docu.id}">Delete</button>`
          :""}
        </div>

        <div class="comment-text">${c.text}</div>
        <div class="comment-meta">${c.createdAt?.toDate? c.createdAt.toDate().toLocaleString() : ""}</div>

        <div class="comment-likes-row" data-commentid="${docu.id}" data-postid="${postId}">
          <span class="comment-like-btn-box">Like <span class="comment-like-count">0</span></span>
          <span class="comment-dislike-btn-box">Dislike <span class="comment-dislike-count">0</span></span>
        </div>
      `;
      listDiv.appendChild(div);

      loadCommentLikeState(postId, docu.id);
      loadCommentDislikeState(postId, docu.id);
    });
  });
}

/* ---------------------------
      LIKE STATES
----------------------------*/
function loadLikeState(postId){
  const likesRef = collection(db,"posts",postId,"likes");
  onSnapshot(likesRef,snap=>{
    const countSpan=document.querySelector(`.likes-row[data-id="${postId}"] .like-count`);
    const btn=document.querySelector(`.likes-row[data-id="${postId}"] .like-btn-box`);
    if(countSpan) countSpan.innerText=snap.size;
    if(btn && auth.currentUser) btn.style.fontWeight=snap.docs.some(d=>d.id===auth.currentUser.uid)?"bold":"normal";
  });
}

function loadDislikeState(postId){
  const dislikesRef = collection(db,"posts",postId,"dislikes");
  onSnapshot(dislikesRef,snap=>{
    const countSpan=document.querySelector(`.likes-row[data-id="${postId}"] .dislike-count`);
    const btn=document.querySelector(`.likes-row[data-id="${postId}"] .dislike-btn-box`);
    if(countSpan) countSpan.innerText=snap.size;
    if(btn && auth.currentUser) btn.style.fontWeight=snap.docs.some(d=>d.id===auth.currentUser.uid)?"bold":"normal";
  });
}

function loadCommentLikeState(postId,commentId){
  const likesRef=collection(db,"posts",postId,"comments",commentId,"likes");
  onSnapshot(likesRef,snap=>{
    const countSpan=document.querySelector(`.comment-likes-row[data-commentid="${commentId}"] .comment-like-count`);
    const btn=document.querySelector(`.comment-likes-row[data-commentid="${commentId}"] .comment-like-btn-box`);
    if(countSpan) countSpan.innerText=snap.size;
    if(btn && auth.currentUser) btn.style.fontWeight=snap.docs.some(d=>d.id===auth.currentUser.uid)?"bold":"normal";
  });
}

function loadCommentDislikeState(postId,commentId){
  const dislikesRef=collection(db,"posts",postId,"comments",commentId,"dislikes");
  onSnapshot(dislikesRef,snap=>{
    const countSpan=document.querySelector(`.comment-likes-row[data-commentid="${commentId}"] .comment-dislike-count`);
    const btn=document.querySelector(`.comment-likes-row[data-commentid="${commentId}"] .comment-dislike-btn-box`);
    if(countSpan) countSpan.innerText=snap.size;
    if(btn && auth.currentUser) btn.style.fontWeight=snap.docs.some(d=>d.id===auth.currentUser.uid)?"bold":"normal";
  });
}

/* ---------------------------
      CLICK HANDLER
----------------------------*/
discussionContainer.addEventListener("click",async e=>{

  if(!auth.currentUser) return showSignInMenu();

  /* POST LIKE (with swap) */
  if (e.target.classList.contains("like-btn-box")) {
    const row = e.target.parentElement;
    const postId = row.getAttribute("data-id");

    const likeRef = doc(db, "posts", postId, "likes", auth.currentUser.uid);
    const dislikeRef = doc(db, "posts", postId, "dislikes", auth.currentUser.uid);

    const likeSnap = await getDoc(likeRef);
    const dislikeSnap = await getDoc(dislikeRef);

    if (likeSnap.exists()) {
      await deleteDoc(likeRef);
    } else {
      if (dislikeSnap.exists()) await deleteDoc(dislikeRef);
      await setDoc(likeRef, { likedAt: serverTimestamp() });
    }
  }

  /* POST DISLIKE (with swap) */
  if (e.target.classList.contains("dislike-btn-box")) {
    const row = e.target.parentElement;
    const postId = row.getAttribute("data-id");

    const likeRef = doc(db, "posts", postId, "likes", auth.currentUser.uid);
    const dislikeRef = doc(db, "posts", postId, "dislikes", auth.currentUser.uid);

    const likeSnap = await getDoc(likeRef);
    const dislikeSnap = await getDoc(dislikeRef);

    if (dislikeSnap.exists()) {
      await deleteDoc(dislikeRef);
    } else {
      if (likeSnap.exists()) await deleteDoc(likeRef);
      await setDoc(dislikeRef, { dislikedAt: serverTimestamp() });
    }
  }

  /* COMMENT LIKE (with swap) */
  if (e.target.closest(".comment-like-btn-box")) {
    const row = e.target.closest(".comment-likes-row");
    const postId = row.getAttribute("data-postid");
    const commentId = row.getAttribute("data-commentid");

    const likeRef = doc(db, "posts", postId, "comments", commentId, "likes", auth.currentUser.uid);
    const dislikeRef = doc(db, "posts", postId, "comments", commentId, "dislikes", auth.currentUser.uid);

    const likeSnap = await getDoc(likeRef);
    const dislikeSnap = await getDoc(dislikeRef);

    if (likeSnap.exists()) {
      await deleteDoc(likeRef);
    } else {
      if (dislikeSnap.exists()) await deleteDoc(dislikeRef);
      await setDoc(likeRef, { likedAt: serverTimestamp() });
    }
  }

  /* COMMENT DISLIKE (with swap) */
  if (e.target.closest(".comment-dislike-btn-box")) {
    const row = e.target.closest(".comment-likes-row");
    const postId = row.getAttribute("data-postid");
    const commentId = row.getAttribute("data-commentid");

    const likeRef = doc(db, "posts", postId, "comments", commentId, "likes", auth.currentUser.uid);
    const dislikeRef = doc(db, "posts", postId, "comments", commentId, "dislikes", auth.currentUser.uid);

    const likeSnap = await getDoc(likeRef);
    const dislikeSnap = await getDoc(dislikeRef);

    if (dislikeSnap.exists()) {
      await deleteDoc(dislikeRef);
    } else {
      if (likeSnap.exists()) await deleteDoc(likeRef);
      await setDoc(dislikeRef, { dislikedAt: serverTimestamp() });
    }
  }

  /* DELETE POST */
  if(e.target.classList.contains("delete-post-btn")){
    deleteTarget={type:"post",postId:e.target.getAttribute("data-id")};
    deleteMessage.innerText="Are you sure you want to delete this post?";
    deleteConfirmPanel.style.display="flex";
  }

  /* DELETE COMMENT */
  if(e.target.classList.contains("delete-comment-btn")){
    deleteTarget={
      type:"comment",
      postId:e.target.getAttribute("data-postid"),
      commentId:e.target.getAttribute("data-commentid")
    };
    deleteMessage.innerText="Are you sure you want to delete this comment?";
    deleteConfirmPanel.style.display="flex";
  }
});

/* ---------------------------
      DELETE CONFIRM
----------------------------*/
confirmDeleteBtn.onclick=async()=>{
  if(!deleteTarget) return;

  if(deleteTarget.type==="post")
    await deleteDoc(doc(db,"posts",deleteTarget.postId));

  else if(deleteTarget.type==="comment")
    await deleteDoc(doc(db,"posts",deleteTarget.postId,"comments",deleteTarget.commentId));

  deleteTarget=null;
  deleteConfirmPanel.style.display="none";
};

cancelDeleteBtn.onclick = closeDeletePanel.onclick = ()=>{
  deleteTarget=null;
  deleteConfirmPanel.style.display="none";
};

/* ---------------------------
      POST VIEW COUNT
----------------------------*/
async function recordView(postId) {
  const viewsRef = collection(db, "posts", postId, "views");

  await addDoc(viewsRef, {
    viewedAt: serverTimestamp(),
    user: auth.currentUser ? auth.currentUser.uid : "guest"
  });
}

function loadViewCount(postId) {
  const viewsRef = collection(db, "posts", postId, "views");
  onSnapshot(viewsRef, snap => {
    const span = document.querySelector(`.view-count[data-id="${postId}"]`);
    if (span) span.innerText = `${snap.size} views`;
  });
}
</script>

  <div class="section-bar4"></div>

<style>
  .ad-footer {
    margin-top: 10px;
    margin-bottom: 10px;
    width: 100%;
    height: 150px;
    border: 2px dashed #999;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #666;
    font-size: 18px;
    text-align: center;
    background-color: #fff; 
    cursor: pointer;
    transition: border-color 0.3s;
  }

footer {
  width: 100%;
  height: 90px;
  background-color: #00193f;
  color: #fff;
  text-align: center;
  padding: 1rem;
  margin-top: 0px;
}
.social-icons a img {
   width: 24px;
  height: 24px;
  margin-left: 1rem;
  transition: filter 0.3s;
  filter: brightness(0) invert(1);
}
.social-icons a img:hover { 
  filter: brightness(0) saturate(100%) invert(38%) sepia(89%) saturate(5634%) hue-rotate(186deg) brightness(95%) contrast(100%);
}
</style>

<div class="ad-footer">Advertise here! Contact for more info!</div>

<div class="section-bar5"></div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Geordie Land News. All rights reserved.</p>
    <div class="social-icons">
      <a href="https://www.instagram.com/geordielandnews/" target="_blank"><img src="pictures/Instagram.png" alt="Instagram Logo"></a>
      <a href="https://x.com/GeordieLandNews" target="_blank"><img src="pictures/X.png" alt="X Logo"></a>
    </div>
  </footer>
